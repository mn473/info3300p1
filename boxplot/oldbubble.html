<html>
    <head>
        <title>Bubble Chart - Perfume Data</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <style>
            h3 {
                font-family: 'Arial', sans-serif; 
                text-align: center; 
                font-size: 24px; 
                margin-bottom: 20px;
            }
            .bubble {
                fill-opacity: 0.6;
                stroke: black;
            }
            .grid-line {
                stroke: lightgray;
                stroke-width: 2px;
                stroke-dasharray: 4;
            }

            #chart,
            #legend1, 
            #legend2 {
                    font-family: 'Arial', sans-serif;
                    text-align: center; 
            }
        </style>
    </head>
    <body>
        <h3>Perfumes: Price vs Scent Groups with Bottle Sizes and Concentrations</h3>
        <div id="chart"></div>
        <div id="legend1"></div>
        <div id="legend2"></div>

        <script>
            d3.csv("../noon_perfumes_dataset.csv").then(function(data) {
                data.forEach(d => {
                    d['new_price'] = Number(d['new_price']);
                    d['ml'] = Number(d['ml']);
                });

                const scentGroups = [];
                data.forEach(d => {
                    if (!scentGroups.includes(d.scents_group)) {
                        scentGroups.push(d.scents_group);
                    }
                });

                data = data.filter(d => d['ml'] >= 30);

                const scentGroupsWithAvgPrice = [];
                scentGroups.forEach(group => {
                    let totalPrice = 0;
                    let count = 0;
                    data.forEach(d => {
                        if (d.scents_group === group) {
                            totalPrice += d['new_price']; 
                            count += 1;
                        }
                    });
                    const avgPrice = totalPrice / count;
                    scentGroupsWithAvgPrice.push({ group, avgPrice });
                });

                for (let i = 0; i < scentGroupsWithAvgPrice.length; i++) {
                    for (let j = 0; j < scentGroupsWithAvgPrice.length - 1; j++) {
                        if (scentGroupsWithAvgPrice[j].avgPrice > scentGroupsWithAvgPrice[j + 1].avgPrice) {
                            let temp = scentGroupsWithAvgPrice[j];
                            scentGroupsWithAvgPrice[j] = scentGroupsWithAvgPrice[j + 1];
                            scentGroupsWithAvgPrice[j + 1] = temp;
                        }
                    }
                }

                const concentrations = []; 
                data.forEach(d => {
                    if (!concentrations.includes(d.concentration)) {
                        concentrations.push(d.concentration);
                    }
                });

                const margin = {top: 30, right: 30, bottom: 90, left: 60};
                const width = 1500 - margin.left - margin.right;
                const height = 700 - margin.top - margin.bottom;

                const svg = d3.select("#chart")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                            .domain(scentGroupsWithAvgPrice.map(d => d.group))
                            .range([0, width]);

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickSize(0))
                    .selectAll("text")
                    .remove();  

                scentGroupsWithAvgPrice.forEach(groupObj => {
                    const group = groupObj.group;
                    const avgPrice = groupObj.avgPrice.toFixed(2);
                    svg.append("text")
                        .attr("x", x(group) + x.bandwidth() / 2)
                        .attr("y", height + 30)
                        .attr("text-anchor", "middle")
                        .text(`${group} ($${avgPrice})`);
                });

                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height + 60)
                    .attr("text-anchor", "middle")
                    .attr("font-size", "16px")
                    .style("font-weight", "bold") 
                    .text("Scent Groups (Average Price)");

                scentGroupsWithAvgPrice.forEach(groupObj => {
                    const group = groupObj.group;
                    svg.append("line")
                        .attr("class", "grid-line")
                        .attr("x1", x(group))
                        .attr("x2", x(group))
                        .attr("y1", 0)
                        .attr("y2", height);
                });

                const y = d3.scaleLinear().domain([0, 900]).range([height, 0]);

                svg.append("g")
                    .call(d3.axisLeft(y).tickFormat(d3.format("$~s")));

                svg.append("text")
                    .attr("x", -height / 2)
                    .attr("y", -40)
                    .attr("text-anchor", "middle")
                    .attr("font-size", "16px")
                    .style("font-weight", "bold") 
                    .attr("transform", "rotate(-90)")
                    .text("Price (New Price)");
                
                const colorScaleC = d3.scaleOrdinal()
                    .domain(["EDC", "EDT", "PDT", "EDP", "Oil"])  
                    .range(["#e78ac3", "#fc8d62", "#0096FF", "#1b9e77", "#084081"]);
            
                svg.selectAll("circle")
                    .data(data)
                        .join(
                            enter => {
                                enter.append("circle")
                                .attr("class", "bubble")
                                .attr("cx", d => sizeBasedPosition(x(d['scents_group']) + x.bandwidth() / 2, x.bandwidth(), d['ml'])) 
                                .attr("cy", d => y(d['new_price']))
                                .attr("r", d => getBubbleSize(d['ml'])) 
                                .attr("fill", d => colorScaleC(d['concentration']));  
                            },
                            update => {
                                update
                                .attr("class", "bubble")
                                .attr("cx", d => sizeBasedPosition(x(d['scents_group']) + x.bandwidth() / 2, x.bandwidth(), d['ml']))  
                                .attr("cy", d => y(d['new_price']))
                                .attr("r", d => getBubbleSize(d['ml'])) 
                                .attr("fill", d => colorScaleC(d['concentration'])); 
                            },
                            exit => {
                                exit.remove();  
                            }
                        );

                const concentrationsLegend = colorScaleC.domain(); 
                d3.select("#legend1")
                    .append("span")
                    .text("Concentration: ")
                    .style("font-weight", "bold")
                    .style("font-size", "14px")
                    .style("margin-right", "10px"); 
                
                concentrationsLegend.forEach(concentration => {
                    if (concentration == "Oil") {
                        return; 
                    }
                    
                    let displayText = concentration;
                    if (concentration === "EDP") {
                        displayText += " (15-20%)";
                    } else if (concentration === "PDT") {
                        displayText += " (10-20%)";
                    } else if (concentration === "EDT") {
                        displayText += " (5-15%)";
                    } else if (concentration === "EDC") {
                        displayText += " (2-5%)";
                    }
                    d3.select("#legend1").append("span")
                        .style("display", "inline-block")
                        .style("width", "40px")
                        .style("height", "20px")
                        .style("background-color", colorScaleC(concentration)) 
                        .style("margin-right", "10px");

                    d3.select("#legend1").append("span")
                        .text(displayText)
                        .style("margin-right", "20px")
                        .style("cursor", "pointer")
                        .style("font-size", "14px");
                });

                const bottleSizes = [
                    {label: "Small (30-50ML)", radius:2},
                    {label: "Medium (50-90ML)", radius: 8},
                    {label: "Large (90-120ML)", radius: 14},
                    {label: "Extra Large (>=120ML)", radius: 21}
                ];

                d3.select("#legend2")
                    .append("span")
                    .text("Bottle Size: ")
                    .style("font-weight", "bold")  
                    .style("font-size", "14px")
                    .style("margin-right", "10px");
            
                bottleSizes.forEach(size => {
                    d3.select("#legend2").append("div")
                        .style("width", size.radius * 2 + "px")  
                        .style("height", size.radius * 2 + "px") 
                        .style("border-radius", "50%")  
                        .style("background-color", "lightgrey")  
                        .style("border", "1px solid black")  
                        .style("display", "inline-block")  
                        .style("vertical-align", "middle")  
                        .style("margin-right", "10px");

                    d3.select("#legend2").append("span")
                        .text(size.label)
                        .style("margin-right", "20px")
                        .style("font-size", "14px")
                        .style("display", "inline-block");
                });

    const line = d3.line()
        .x(d => x(d.group) + x.bandwidth() / 2)  
        .y(d => y(d.avgPrice));

        svg.append("path")
        .datum(scentGroupsWithAvgPrice)
        .attr("class", "avg-line")
        .attr("d", line)
        .attr("fill", "none") 
        .attr("stroke", "red") 
        .attr("stroke-width", 2); 



    svg.selectAll(".avg-circle")
        .data(scentGroupsWithAvgPrice)
        .enter()
        .append("circle")
        .attr("class", "avg-circle")
        .attr("cx", d => x(d.group) + x.bandwidth() / 2)
        .attr("cy", d => y(d.avgPrice))
        .attr("r", 5);


                function sizeBasedPosition(cx, bandwidth, ml) {
                    if (ml >= 30 && ml < 50) {
                        return cx - (bandwidth * 0.45);  
                    } else if (ml >= 50 && ml < 90) {
                        return cx - (bandwidth * 0.25);  
                    } else if (ml >= 90 && ml < 120) {
                        return cx + (bandwidth * 0.0);  
                    } else if (ml >= 120) {
                        let xPosition = cx + (bandwidth * 0.4); 

                        xPosition -= 10;  
                        return xPosition;
                    } else {
                        return cx;
                    }
                }

                function getBubbleSize(ml) {
                    if (ml >=30 && ml < 50) {
                        return 3;  
                    } else if (ml >= 50 && ml < 90) {
                        return 8;  
                    } else if (ml >= 90 && ml < 120) {
                        return 15;  
                    } else if (ml >= 120) {
                        return 22;  
                    } else {
                        return 5;  
                    }
                }

                svg.selectAll(".grid").remove();
            });
        </script>
    </body>
</html>