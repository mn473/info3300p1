<html>
<head>
    <title>Top 20 Middle Notes per Scent Group</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h3>Top 20 Middle Notes per Scent Group</h3>
    <svg id="stackedchart" width="800" height="600"></svg>
    <text id="label" x="760" y="0" text-anchor="end" alignment-baseline="hanging"></text>

    <script>
    const svg = d3.select('svg#stackedchart');
    const width = svg.attr('width');
    const height = svg.attr('height');

    const margins = { top: 20, right: 20, bottom: 100, left: 70 };
    const chartWidth = width - margins.left - margins.right;
    const chartHeight = height - margins.top - margins.bottom;

    const chartArea = svg.append('g')
        .attr('transform', `translate(${margins.left}, ${margins.top})`);

    d3.csv("filtered_top_10_scents.csv").then(function(data) {
        data = data.filter(d => d['scents_group'] && d['middle_note']);
        
        let noteFrequency = {};

        data.forEach(d => {
            let middleNotes = d['middle_note'].split(/,|\s+and\s+/i).map(note => note.trim());
            let scent = d['scents_group']; 

            middleNotes.forEach(note => {
                if (!noteFrequency[note]) {
                    noteFrequency[note] = {};
                }
                
                if (!noteFrequency[note][scent]) {
                    noteFrequency[note][scent] = 0;
                }

                noteFrequency[note][scent]++;
            });
        });

        //  top 20 notes by total frequency
        let totalNoteFrequency = {};
        for (let note in noteFrequency) {
            let totalCount = 0;
            for (let scent in noteFrequency[note]) {
                totalCount += noteFrequency[note][scent];
            }
            totalNoteFrequency[note] = totalCount;
        }

        let topNotes = Object.entries(totalNoteFrequency)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 20)
            .map(entry => entry[0]);

        // top 10 scents
        let scents = Array.from(new Set(data.map(d => d['scents_group']))).slice(0, 10);

        let stackedData = [];
        scents.forEach(scent => {
            let entry = { scent: scent };
            topNotes.forEach(note => {
                entry[note] = noteFrequency[note] && noteFrequency[note][scent] ? noteFrequency[note][scent] : 0;
            });
            stackedData.push(entry);
        });

        //  scales
        const xScale = d3.scaleBand()
            .domain(scents)
            .range([0, chartWidth])
            .padding([0.1]);

        const yScale = d3.scaleLinear()
            .domain([0, d3.max(stackedData, d => {
                return d3.sum(topNotes, note => d[note]);
            })])
            .range([chartHeight, 0]);

        // x-axis
        chartArea.append('g')
            .attr('class', 'x axis')
            .attr('transform', `translate(0, ${chartHeight})`)
            .call(d3.axisBottom(xScale))
            .selectAll('text')
            .style('text-anchor', 'end')
            .attr('dx', '-7px')
            .attr('dy', '0.15em')
            .attr('transform', 'rotate(-40)');

        // y-axis
        chartArea.append('g')
            .attr('class', 'y axis')
            .call(d3.axisLeft(yScale));

        // x-axis label
        chartArea.append("text")
            .attr("x", chartWidth / 2)
            .attr("y", chartHeight + margins.bottom - 20)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .text("Scent Groups");

        // y-axis label
        chartArea.append("text")
            .attr("text-anchor", "middle")
            .attr("transform", `translate(${-margins.left + 20}, ${chartHeight / 2}) rotate(-90)`)
            .style("font-size", "16px")
            .text("Frequency of Middle Notes");

        const color = d3.scaleOrdinal()
            .domain(topNotes)
            .range(d3.schemePastel1);

        // stack
        const stackedDataForD3 = d3.stack()
            .keys(topNotes)
            (stackedData);

        // bars 
        chartArea.append("g")
            .selectAll("g")
            .data(stackedDataForD3)
            .enter().append("g")
            .attr("fill", d => color(d.key))
            .selectAll("rect")
            .data(d => d)
            .enter().append("rect")
            .attr("x", d => xScale(d.data.scent))
            .attr("y", d => yScale(d[1]))
            .attr("height", d => yScale(d[0]) - yScale(d[1]))
            .attr("width", xScale.bandwidth())
            .attr("stroke", "grey")
            .on("mouseover", function(event, d) {
                const noteName = d3.select(this.parentNode).datum().key;
                d3.select("#label").text(`${noteName}`);
                d3.select(this).attr("opacity", 0.7);
            })
            .on("mouseleave", function() {
                d3.select("#label").text("");
                d3.select(this).attr("opacity", 1);
            });
    
    });

    </script>
</body>
</html>
